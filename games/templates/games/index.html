{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xiangqi vs AI - Start Game</title>
    <link rel="icon" type="image/svg+xml" href="{% static 'games/img/favicon.svg' %}">
    <link rel="stylesheet" href="{% static 'games/css/start-screen.css' %}">
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Ma+Shan+Zheng&family=Noto+Serif:wght@400;500;600;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <!-- Mahogany wood background -->
    <div class="wood-background">
        <!-- Ornamental border corners -->
        <div class="border-ornament top-left"></div>
        <div class="border-ornament top-right"></div>
        <div class="border-ornament bottom-left"></div>
        <div class="border-ornament bottom-right"></div>

        <!-- Header -->
        <header class="game-header">
            <div class="logo">
                <svg class="logo-icon" width="40" height="40" viewBox="0 0 100 100" fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="45" stroke="white" stroke-width="3" fill="none" />
                    <text x="50" y="65" font-family="Ma Shan Zheng" font-size="48" fill="white"
                        text-anchor="middle">Â∞á</text>
                </svg>
            </div>
            <nav class="nav-links">
                <a href="#rules">Rules</a>
                <a href="#about">About</a>
            </nav>
        </header>

        <!-- Central decorative plaque frame -->
        <div class="plaque-container entrance-animate">
            <div class="plaque-frame">
                <!-- Carved decorations on frame -->
                <div class="frame-decoration top"></div>
                <div class="frame-decoration bottom"></div>
                <div class="frame-decoration left"></div>
                <div class="frame-decoration right"></div>

                <!-- Inner content area -->
                <div class="plaque-content">
                    <!-- Corner decorations -->
                    <div class="corner-decoration tl"></div>
                    <div class="corner-decoration tr"></div>
                    <div class="corner-decoration bl"></div>
                    <div class="corner-decoration br"></div>

                    <!-- Title -->
                    <h1 class="game-title">Xiangqi</h1>
                    <p class="subtitle">Ch·ªçn c√†i ƒë·∫∑t ƒë·ªÉ b·∫Øt ƒë·∫ßu m·ªôt v√°n c·ªù m·ªõi.</p>

                    <!-- Game Setup Form -->
                    <form method="POST">
                        {% csrf_token %}

                        <!-- Difficulty Selection -->
                        <div class="form-group">
                            <label for="difficulty">Difficulty:</label>
                            <div class="select-wrapper">
                                <select name="difficulty" id="difficulty">
                                    <option value="easy">Easy (max depth 2)</option>
                                    <option value="normal" selected>Normal (max depth 3)</option>
                                    <option value="hard">Hard (time search)</option>
                                </select>
                                <div class="select-arrow"></div>
                            </div>
                        </div>

                        <!-- Player Side Selection -->
                        <div class="form-group">
                            <label for="player_side">Play as:</label>
                            <div class="select-wrapper">
                                <select name="player_side" id="player_side">
                                    <option value="r" selected>Red (Goes First)</option>
                                    <option value="b">Black (Goes Second)</option>
                                </select>
                                <div class="select-arrow"></div>
                            </div>
                        </div>

                        <!-- Start Game Button -->
                        <button type="submit" class="start-button">Start Game</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Decorative sparkle effect -->
        <div class="sparkle sparkle-1"></div>
        <div class="sparkle sparkle-2"></div>
        <div class="sparkle sparkle-3"></div>

        <!-- Floating dust particles -->
        <div class="dust dust-1"></div>
        <div class="dust dust-2"></div>
        <div class="dust dust-3"></div>
        <div class="dust dust-4"></div>
        <div class="dust dust-5"></div>
        <div class="dust dust-6"></div>
        <div class="dust dust-7"></div>
        <div class="dust dust-8"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         "S·ªï Lu·∫≠t" (Rules Book) Modal Overlay
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="rulesOverlay" class="rules-overlay" hidden aria-modal="true" role="dialog" aria-labelledby="rulesTitle">
        <!-- Close button top right -->
        <button class="book-close" id="btnCloseRules" aria-label="ƒê√≥ng" title="ƒê√≥ng (ESC)">‚úï</button>

        <div class="book-spread" id="bookSpread">

            <!-- Tr·ª•c g·ªØa (Spine visual) -->
            <div class="book-spine-center"></div>

            <!-- ================= TRANG TR√ÅI (TOC) ================= -->
            <div class="book-page-left" id="bookLeft">
                <div class="book-header-left">
                    <h2 class="book-hanzi-left">Ê£ãÂæã</h2>
                    <span class="book-sub-header">Quy·ªÉn Lu·∫≠t</span>
                    <div class="ink-divider"></div>
                </div>

                <ul class="book-toc" id="bookToc">
                    <li data-target="0" class="active">
                        <span class="toc-num">I</span> B√†n c·ªù & m·ª•c ti√™u
                        <span class="toc-seal">Èñ±</span>
                    </li>
                    <li data-target="1">
                        <span class="toc-num">II</span> Qu√¢n c·ªù
                        <span class="toc-seal">Èñ±</span>
                    </li>
                    <li data-target="2">
                        <span class="toc-num">III</span> X·∫øp qu√¢n ban ƒë·∫ßu
                        <span class="toc-seal">Èñ±</span>
                    </li>
                    <li data-target="3">
                        <span class="toc-num">IV</span> X·∫øp qu√¢n (chi ti·∫øt)
                        <span class="toc-seal">Èñ±</span>
                    </li>
                    <li data-target="4">
                        <span class="toc-num">V</span> Lu·∫≠t ƒëi qu√¢n (Ph·∫ßn 1)
                        <span class="toc-seal">Èñ±</span>
                    </li>
                    <li data-target="5">
                        <span class="toc-num">VI</span> Lu·∫≠t ƒëi qu√¢n (Ph·∫ßn 2)
                        <span class="toc-seal">Èñ±</span>
                    </li>
                    <li data-target="6">
                        <span class="toc-num">VII</span> ƒÇn qu√¢n, Chi·∫øu/B√≠
                        <span class="toc-seal">Èñ±</span>
                    </li>
                    <li data-target="7">
                        <span class="toc-num">VIII</span> H√≤a & Ghi nh·ªõ nhanh
                        <span class="toc-seal">Èñ±</span>
                    </li>
                </ul>

                <div class="book-tips">
                    <p>‚ú¶ G·ª£i √Ω: Click m√©p ph·∫£i/tr√°i ƒë·ªÉ l·∫≠t trang.</p>
                    <p>‚ú¶ D√πng ph√≠m <kbd>‚Üê</kbd> <kbd>‚Üí</kbd> ƒë·ªÉ xem nhanh.</p>
                </div>
            </div>

            <!-- ================= TRANG PH·∫¢I (CONTENT) ================= -->
            <div class="book-page-right-wrapper" id="bookRightWrapper">

                <div class="book-content" id="bookContent">

                    <!-- Page 1 -->
                    <div class="book-page" data-page="1">
                        <h2 class="book-chapter-title">1) B√†n c·ªù & m·ª•c ti√™u</h2>
                        <p class="book-summary">B√†n c·ªù 9√ó10, ch∆°i tr√™n giao ƒëi·ªÉm; gi·ªØa c√≥ s√¥ng; m·ªói b√™n c√≥ cung 3√ó3.</p>

                        <div class="rule-cards">
                            <div class="rule-card"><strong>9 c·ªôt √ó 10 h√†ng</strong> (ƒëi·ªÉm giao)</div>
                            <div class="rule-card"><strong>S√¥ng</strong> ngƒÉn c√°ch hai b√™n</div>
                            <div class="rule-card"><strong>C·ª≠u cung 3√ó3</strong> (n∆°i T∆∞·ªõng, Sƒ©)</div>
                            <div class="rule-card"><strong>M·ª•c ti√™u:</strong> Chi·∫øu h·∫øt ho·∫∑c √©p b√≠</div>
                        </div>

                        <div class="mini-table">
                            <div class="mt-row">
                                <div class="mt-key">Cung ƒêen</div>
                                <div class="mt-val">c·ªôt 3‚Äì5, h√†ng 0‚Äì2</div>
                            </div>
                            <div class="mt-row">
                                <div class="mt-key">Cung ƒê·ªè</div>
                                <div class="mt-val">c·ªôt 3‚Äì5, h√†ng 7‚Äì9</div>
                            </div>
                        </div>

                        <div class="book-callout style-info">
                            üìå <strong>Th√¥ng l·ªá:</strong> ƒê·ªè ƒëi tr∆∞·ªõc.
                        </div>
                    </div>

                    <!-- Page 2 -->
                    <div class="book-page" data-page="2" hidden>
                        <h2 class="book-chapter-title">2) Qu√¢n c·ªù</h2>
                        <p class="book-summary">M·ªói b√™n c√≥ 16 qu√¢n chia th√†nh 7 lo·∫°i:</p>

                        <div class="rule-cards rule-cards-pieces">
                            <div class="rule-card rc-piece"><strong>T∆∞·ªõng (So√°i)</strong> √ó1</div>
                            <div class="rule-card rc-piece"><strong>Sƒ©</strong> √ó2</div>
                            <div class="rule-card rc-piece"><strong>T∆∞·ª£ng</strong> √ó2</div>
                            <div class="rule-card rc-piece"><strong>Xe</strong> √ó2</div>
                            <div class="rule-card rc-piece"><strong>Ph√°o</strong> √ó2</div>
                            <div class="rule-card rc-piece"><strong>M√£</strong> √ó2</div>
                            <div class="rule-card rc-piece"><strong>T·ªët</strong> √ó5</div>
                        </div>
                    </div>

                    <!-- Page 3 -->
                    <div class="book-page" data-page="3" hidden>
                        <h2 class="book-chapter-title">3) X·∫øp qu√¢n ban ƒë·∫ßu</h2>
                        <p class="book-summary">B·ªë tr√≠ 16 qu√¢n c·ªù tr√™n c√°c ƒëi·ªÉm giao h·ª£p l·ªá.</p>

                        <div class="rule-cards">
                            <div class="rule-card"><strong>H√†ng ƒë√°y:</strong><br>Xe ‚Äì M√£ ‚Äì T∆∞·ª£ng ‚Äì Sƒ© ‚Äì T∆∞·ªõng ‚Äì Sƒ© ‚Äì
                                T∆∞·ª£ng ‚Äì M√£ ‚Äì Xe</div>
                            <div class="rule-card"><strong>Ph√°o:</strong> H√†ng 3 (t√≠nh t·ª´ ƒë√°y), c·ªôt 1 v√† 7</div>
                            <div class="rule-card"><strong>T·ªët:</strong> H√†ng 4 (t√≠nh t·ª´ ƒë√°y), c·ªôt 0, 2, 4, 6, 8</div>
                        </div>
                    </div>

                    <!-- Page 4 -->
                    <div class="book-page" data-page="4" hidden>
                        <h2 class="book-chapter-title">4) X·∫øp qu√¢n (chi ti·∫øt t·ªça ƒë·ªô)</h2>
                        <p class="book-summary">V·ªã tr√≠ khi ƒë√°nh s·ªë h√†ng 0 (ƒêen) ‚Üí 9 (ƒê·ªè) v√† c·ªôt 0 ‚Üí 8.</p>

                        <div class="mini-table">
                            <div class="mt-row mt-header">
                                <div class="mt-key">B√™n ƒêen</div>
                                <div class="mt-val"></div>
                            </div>
                            <div class="mt-row">
                                <div class="mt-key">H√†ng 0</div>
                                <div class="mt-val">Xe(0) M√£(1) T∆∞·ª£ng(2) Sƒ©(3) T∆∞·ªõng(4) Sƒ©(5) T∆∞·ª£ng(6) M√£(7) Xe(8)</div>
                            </div>
                            <div class="mt-row">
                                <div class="mt-key">H√†ng 2</div>
                                <div class="mt-val">Ph√°o t·∫°i c·ªôt 1 v√† 7</div>
                            </div>
                            <div class="mt-row">
                                <div class="mt-key">H√†ng 3</div>
                                <div class="mt-val">T·ªët t·∫°i c·ªôt 0, 2, 4, 6, 8</div>
                            </div>
                        </div>

                        <div class="mini-table" style="margin-top: 15px;">
                            <div class="mt-row mt-header">
                                <div class="mt-key">B√™n ƒê·ªè</div>
                                <div class="mt-val"></div>
                            </div>
                            <div class="mt-row">
                                <div class="mt-key">H√†ng 9</div>
                                <div class="mt-val">Xe(0) M√£(1) T∆∞·ª£ng(2) Sƒ©(3) T∆∞·ªõng(4) Sƒ©(5) T∆∞·ª£ng(6) M√£(7) Xe(8)</div>
                            </div>
                            <div class="mt-row">
                                <div class="mt-key">H√†ng 7</div>
                                <div class="mt-val">Ph√°o t·∫°i c·ªôt 1 v√† 7</div>
                            </div>
                            <div class="mt-row">
                                <div class="mt-key">H√†ng 6</div>
                                <div class="mt-val">T·ªët t·∫°i c·ªôt 0, 2, 4, 6, 8</div>
                            </div>
                        </div>
                    </div>

                    <!-- Page 5 -->
                    <div class="book-page" data-page="5" hidden>
                        <h2 class="book-chapter-title">5) Lu·∫≠t ƒëi qu√¢n (Ph·∫ßn 1)</h2>
                        <p class="book-summary">Quy t·∫Øc di chuy·ªÉn c·ªßa nh√≥m ph√≤ng th·ªß b·∫£o v·ªá T∆∞·ªõng.</p>

                        <div class="rule-cards">
                            <div class="rule-card">
                                <strong>T∆∞·ªõng (So√°i)</strong> <br>
                                ‚Ä¢ ƒêi 1 b∆∞·ªõc ngang/d·ªçc, kh√¥ng ra kh·ªèi cung. <br>
                                ‚Ä¢ Lu·∫≠t "phi t∆∞·ªõng": C·∫•m 2 T∆∞·ªõng ƒë·ªëi m·∫∑t c√πng c·ªôt kh√¥ng c√≥ c·∫£n.
                            </div>
                            <div class="rule-card">
                                <strong>Sƒ©</strong> <br>
                                ‚Ä¢ ƒêi 1 b∆∞·ªõc ch√©o. <br>
                                ‚Ä¢ Ch·ªâ di chuy·ªÉn trong cung (t·ªëi ƒëa 5 v·ªã tr√≠).
                            </div>
                            <div class="rule-card">
                                <strong>T∆∞·ª£ng</strong> <br>
                                ‚Ä¢ ƒêi ch√©o 2 b∆∞·ªõc, kh√¥ng qua s√¥ng. <br>
                                ‚Ä¢ B·ªã c·∫£n n·∫øu "m·∫Øt t∆∞·ª£ng" (√¥ gi·ªØa ch√©o) c√≥ qu√¢n.
                            </div>
                        </div>
                    </div>

                    <!-- Page 6 -->
                    <div class="book-page" data-page="6" hidden>
                        <h2 class="book-chapter-title">6) Lu·∫≠t ƒëi qu√¢n (Ph·∫ßn 2)</h2>
                        <p class="book-summary">Quy t·∫Øc di chuy·ªÉn c·ªßa nh√≥m t·∫•n c√¥ng.</p>

                        <div class="rule-cards">
                            <div class="rule-card">
                                <strong>Xe</strong> <br>
                                ‚Ä¢ ƒêi ngang/d·ªçc t√πy √Ω (n·∫øu kh√¥ng v∆∞·ªõng). <br>
                                ‚Ä¢ ƒÇn qu√¢n ngay tr√™n ƒë∆∞·ªùng ƒëi.
                            </div>
                            <div class="rule-card">
                                <strong>M√£</strong> <br>
                                ‚Ä¢ ƒêi ch·ªØ L (1 b∆∞·ªõc th·∫≥ng + 1 b∆∞·ªõc ch√©o). <br>
                                ‚Ä¢ B·ªã c·∫£n n·∫øu "ch√¢n m√£" c√≥ qu√¢n ch·∫∑n.
                            </div>
                            <div class="rule-card">
                                <strong>Ph√°o</strong> <br>
                                ‚Ä¢ ƒêi nh∆∞ Xe (ngang/d·ªçc). <br>
                                ‚Ä¢ ƒÇn qu√¢n <strong>ph·∫£i nh·∫£y qua ƒë√∫ng 1 qu√¢n</strong> ("ng√≤i").
                            </div>
                            <div class="rule-card">
                                <strong>T·ªët</strong> <br>
                                ‚Ä¢ 1 b∆∞·ªõc ti·∫øn. Qua s√¥ng ƒë∆∞·ª£c ƒëi ngang. <br>
                                ‚Ä¢ C·∫•m l√πi. Kh√¥ng phong h·∫≠u.
                            </div>
                        </div>
                    </div>

                    <!-- Page 7 -->
                    <div class="book-page" data-page="7" hidden>
                        <h2 class="book-chapter-title">7) ƒÇn qu√¢n, Chi·∫øu & B√≠</h2>
                        <p class="book-summary">C√°c t√¨nh hu·ªëng kh·ªëng ch·∫ø v√† k·∫øt th√∫c m·∫•u ch·ªët.</p>

                        <div class="rule-cards">
                            <div class="rule-card">
                                <strong>ƒÇn qu√¢n</strong>: Thay th·∫ø qu√¢n ƒë·ªëi ph∆∞∆°ng, lo·∫°i kh·ªèi b√†n. (Kh√¥ng b·∫Øt bu·ªôc).
                            </div>
                            <div class="rule-card">
                                <strong>Chi·∫øu t∆∞·ªõng</strong>: ƒêe d·ªça T∆∞·ªõng. <br>
                                Ph·∫£i ch·∫°y, che c·∫£n, ho·∫∑c ƒÉn qu√¢n chi·∫øu ƒëe d·ªça.
                            </div>
                            <div class="rule-card">
                                <strong>Chi·∫øu h·∫øt</strong>: B·ªã chi·∫øu nh∆∞ng h·∫øt c√°ch ƒë·ª° ‚Üí Thua.
                            </div>
                            <div class="rule-card">
                                <strong>B√≠</strong>: Kh√¥ng b·ªã chi·∫øu nh∆∞ng h·∫øt n∆∞·ªõc ƒëi h·ª£p l·ªá ‚Üí Th∆∞·ªùng x·ª≠ thua.
                            </div>
                        </div>
                    </div>

                    <!-- Page 8 -->
                    <div class="book-page" data-page="8" hidden>
                        <h2 class="book-chapter-title">8) H√≤a & Ghi nh·ªõ nhanh</h2>

                        <p class="book-summary" style="margin-bottom: 8px;">Quy ∆∞·ªõc thi ƒë·∫•u ph·ªï bi·∫øn:</p>
                        <div class="rule-cards">
                            <div class="rule-card"><strong>H√≤a</strong>: L·∫∑p l·∫°i c√πng 1 v·ªã tr√≠ nhi·ªÅu l·∫ßn (th∆∞·ªùng l√† 3).
                            </div>
                            <div class="rule-card"><strong>Chi·∫øu / ƒêu·ªïi dai</strong>: B·ªã c·∫•m ho·∫∑c x·ª≠ thua t√πy gi·∫£i.
                            </div>
                        </div>

                        <div class="book-callout style-warning" style="margin-top: 20px;">
                            <strong>Ghi nh·ªõ th·∫ßn t·ªëc:</strong> <br>
                            ‚Ä¢ Cung "nh·ªët" T∆∞·ªõng & Sƒ©. S√¥ng "c·∫£n" T∆∞·ª£ng.<br>
                            ‚Ä¢ M√£ "c·∫£n ch√¢n", T∆∞·ª£ng "c·∫£n m·∫Øt".<br>
                            ‚Ä¢ Ph√°o "c·∫ßn ng√≤i" m·ªõi ƒÉn ƒë∆∞·ª£c.
                        </div>
                    </div>

                </div> <!-- .book-content -->

                <!-- Red Seal Decoration -->
                <div class="book-right-seal">Âæã</div>

                <!-- Page Numbering -->
                <div class="book-page-number" id="rulesPageIndicator">M·ª•c 1 / 8</div>

                <!-- Corner edge flip areas -->
                <button class="corner-flip corner-prev" id="btnCornerPrev" aria-label="Trang tr∆∞·ªõc"
                    title="Trang tr∆∞·ªõc"></button>
                <button class="corner-flip corner-next" id="btnCornerNext" aria-label="Trang sau"
                    title="Trang sau"></button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.querySelector('form');
            const startBtn = document.querySelector('.start-button');

            if (form && startBtn) {
                form.addEventListener('submit', function (e) {
                    if (startBtn.classList.contains('loading')) {
                        e.preventDefault();
                        return;
                    }
                    startBtn.classList.add('loading');
                    // We don't set startBtn.disabled = true; here because it might prevent the form from submitting in some older browsers if triggered by enter key.
                    // Instead, we style it with pointer-events: none.
                    startBtn.innerHTML = 'Starting...';
                });
            }

            // Smooth scroll for nav
            document.querySelectorAll('.nav-links a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    // Add active class
                    document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
                    this.classList.add('active');

                    const targetId = this.getAttribute('href');
                    if (targetId === '#rules') {
                        openRulesModal();
                        return;
                    }
                    if (targetId && targetId !== '#') {
                        const targetEl = document.querySelector(targetId);
                        if (targetEl) {
                            targetEl.scrollIntoView({
                                behavior: 'smooth'
                            });
                        }
                    }
                });
            });

            // Rules Modal Logic
            const rulesOverlay = document.getElementById('rulesOverlay');
            const btnCloseRules = document.getElementById('btnCloseRules');
            const btnCornerPrev = document.getElementById('btnCornerPrev');
            const btnCornerNext = document.getElementById('btnCornerNext');
            const pageIndicator = document.getElementById('rulesPageIndicator');
            const pages = document.querySelectorAll('.book-page');
            const tocItems = document.querySelectorAll('#bookToc li');
            const bookRightWrapper = document.getElementById('bookRightWrapper');
            let currentPage = 0;
            const totalPages = pages.length;

            function openRulesModal() {
                rulesOverlay.hidden = false;
                currentPage = 0;
                updatePages(false);
                btnCloseRules.focus();

                // Add keyboard listeners
                document.addEventListener('keydown', handleRulesKeydown);
            }

            function closeRulesModal() {
                rulesOverlay.hidden = true;
                document.removeEventListener('keydown', handleRulesKeydown);
            }

            function updatePages(animate = true) {
                // Update TOC highlights
                tocItems.forEach((li, index) => {
                    if (index === currentPage) {
                        li.classList.add('active');
                    } else {
                        li.classList.remove('active');
                    }
                });

                // Update right content visibility with flip animation
                if (animate) {
                    bookRightWrapper.classList.add('flipping');
                    setTimeout(() => {
                        swapPages();
                    }, 130); // half flip animation duration

                    setTimeout(() => {
                        bookRightWrapper.classList.remove('flipping');
                    }, 260); // full flip animation duration
                } else {
                    swapPages();
                }

                function swapPages() {
                    pages.forEach((page, index) => {
                        page.classList.remove('active');
                        page.hidden = true;
                        if (index === currentPage) {
                            page.hidden = false;
                            page.classList.add('active');
                            // scroll back to top of page
                            page.scrollTop = 0;
                        }
                    });
                    pageIndicator.textContent = `Trang ${currentPage + 1} / ${totalPages}`;

                    if (btnCornerPrev) btnCornerPrev.disabled = currentPage === 0;
                    if (btnCornerNext) btnCornerNext.disabled = currentPage === totalPages - 1;
                }
            }

            function nextPage() {
                if (currentPage < totalPages - 1) {
                    currentPage++;
                    updatePages(true);
                }
            }

            function prevPage() {
                if (currentPage > 0) {
                    currentPage--;
                    updatePages(true);
                }
            }

            function handleRulesKeydown(e) {
                if (rulesOverlay.hidden) return;
                if (e.key === 'Escape') closeRulesModal();
                if (e.key === 'ArrowRight') { e.preventDefault(); nextPage(); }
                if (e.key === 'ArrowLeft') { e.preventDefault(); prevPage(); }
                if (e.key === 'Home') {
                    e.preventDefault();
                    if (currentPage !== 0) {
                        currentPage = 0;
                        updatePages(true);
                    }
                }
                if (e.key === 'End') {
                    e.preventDefault();
                    if (currentPage !== totalPages - 1) {
                        currentPage = totalPages - 1;
                        updatePages(true);
                    }
                }
            }

            if (btnCloseRules) btnCloseRules.addEventListener('click', closeRulesModal);
            if (btnCornerNext) btnCornerNext.addEventListener('click', nextPage);
            if (btnCornerPrev) btnCornerPrev.addEventListener('click', prevPage);

            // TOC click to navigate
            tocItems.forEach((li) => {
                li.addEventListener('click', () => {
                    const targetIndex = parseInt(li.getAttribute('data-target'));
                    if (currentPage !== targetIndex) {
                        currentPage = targetIndex;
                        updatePages(true);
                    }
                });
            });

            // Close on backdrop click
            if (rulesOverlay) {
                rulesOverlay.addEventListener('click', (e) => {
                    // Only close if clicked outside the book spread container
                    if (e.target === rulesOverlay) closeRulesModal();
                });
            }
        });
    </script>
</body>

</html>